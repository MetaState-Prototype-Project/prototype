name: "Build All Packages"

on:
  pull_request:
  push:
    branches:
      - "dev"
      - "main"

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.x

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3

      - name: Install pnpm
        run: npm install -g pnpm

      - name: Install Dependencies
        run: |
          # pnpm should install optional dependencies by default, but ensure it does
          pnpm install --no-frozen-lockfile || pnpm install
          
      - name: Fix rollup native module
        run: |
          # Rollup's native modules are optional dependencies that pnpm might not install correctly
          # Install it explicitly at the workspace root to ensure it's available
          pnpm add -w -D @rollup/rollup-linux-x64-gnu || echo "Rollup native module installation skipped (may already be present)"
          
      - name: Rebuild native modules
        run: |
          # Rebuild native modules to ensure compatibility
          pnpm rebuild || echo "Rebuild completed with warnings"

      - name: Build All Packages
        run: pnpm build

