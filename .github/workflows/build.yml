name: "Build All Packages"

on:
    pull_request:
    push:
        branches:
            - "dev"
            - "main"

jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  # Rollup native binaries are tested/stable on Node 20 LTS
                  node-version: 20.x

            - name: Install build dependencies
              run: |
                  sudo apt-get update
                  sudo apt-get install -y build-essential python3

            - name: Install pnpm
              run: npm install -g pnpm

            - name: Install Dependencies
              run: pnpm install

            - name: Clean and rebuild native modules
              run: |
                  # Remove any pre-built binaries that might be incompatible
                  find node_modules -name "*.node" -delete 2>/dev/null || true
                  # Rebuild all native modules
                  pnpm rebuild

            # ðŸ”§ Workaround: Fix missing Rollup native module for marketplace
            - name: Ensure Rollup native binary is installed for marketplace
              working-directory: ./platforms/marketplace
              run: |
                  echo "Cleaning marketplace node_modules and reinstalling with npm (for optional deps)"
                  rm -rf node_modules package-lock.json
                  npm ci

            - name: Build All Packages
              run: pnpm build
