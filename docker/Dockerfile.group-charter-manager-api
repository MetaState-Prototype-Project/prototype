FROM node:18-alpine AS base
RUN apk update && apk add --no-cache libc6-compat
WORKDIR /app

# ---
FROM base AS prepare
RUN corepack enable && corepack prepare pnpm@10.13.1 --activate
RUN npm install -g turbo@^2
COPY . .
# Generate a partial monorepo with a pruned lockfile for group-charter-manager-api
RUN turbo prune group-charter-manager-api --docker

# ---
FROM base AS builder
RUN corepack enable && corepack prepare pnpm@10.13.1 --activate
# Copy workspace config first so pnpm recognizes workspace packages
COPY --from=prepare /app/pnpm-workspace.yaml ./
COPY --from=prepare /app/package.json ./
# Copy infrastructure folder (before install) so postinstall scripts can find tsconfig files
# web3-adapter depends on evault-core, which depends on w3id
COPY --from=prepare /app/infrastructure/w3id ./infrastructure/w3id
COPY --from=prepare /app/infrastructure/evault-core ./infrastructure/evault-core
COPY --from=prepare /app/infrastructure/web3-adapter ./infrastructure/web3-adapter
# First install the dependencies (as they change less often)
# Use --no-frozen-lockfile because w3id dependencies aren't in the pruned lockfile
COPY --from=prepare /app/out/json/ .
RUN pnpm install --no-frozen-lockfile
# Build the project
COPY --from=prepare /app/out/full/ .
# Install dependencies for workspace packages (they need to be recognized as workspace packages)
# Use --no-frozen-lockfile because these weren't in the pruned lockfile
RUN pnpm install --no-frozen-lockfile
# Build workspace dependencies in order, then the main package
RUN pnpm turbo build --filter=w3id && pnpm turbo build --filter=evault-core && pnpm turbo build --filter=web3-adapter && pnpm turbo build --filter=group-charter-manager-api

# ---
FROM base AS runner
RUN corepack enable && corepack prepare pnpm@10.13.1 --activate
# Create parent directory structure for SQLite databases (must exist before volume mount)
RUN mkdir -p /app/data/mapping-dbs/group-charter
# Copy entrypoint script
COPY --from=prepare /app/docker/entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh
# Copy built application
COPY --from=builder /app/platforms/group-charter-manager-api/dist ./platforms/group-charter-manager-api/dist
COPY --from=builder /app/platforms/group-charter-manager-api/package.json ./platforms/group-charter-manager-api/
COPY --from=builder /app/platforms/group-charter-manager-api/node_modules ./platforms/group-charter-manager-api/node_modules
COPY --from=builder /app/infrastructure ./infrastructure
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./
COPY --from=builder /app/pnpm-workspace.yaml ./

WORKDIR /app/platforms/group-charter-manager-api
EXPOSE 3003
ENTRYPOINT ["/usr/local/bin/entrypoint.sh"]
CMD ["pnpm", "start"]

