version: '3.8'

x-common-host-access: &common-host-access
  extra_hosts:
    - "host.docker.internal:host-gateway"

services:
  # PostgreSQL database for social platforms
  postgres:
    image: postgres:15-alpine
    container_name: metastate-postgres-socials
    ports:
      - "5434:5432"
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_MULTIPLE_DATABASES=blabsy_auth,pictique
    volumes:
      - postgres_socials_data:/var/lib/postgresql/data
      - ./db/init-multiple-databases.sh:/docker-entrypoint-initdb.d/init-multiple-databases.sh
    networks:
      - metastate-socials-network
    <<: *common-host-access
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    logging:
      driver: "none"

  # Blabsy W3DS Auth API
  blabsy-w3ds-auth-api:
    profiles:
      - socials
    build:
      context: .
      dockerfile: ./docker/Dockerfile.blabsy-w3ds-auth-api
    container_name: metastate-blabsy-api
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=3000
      - DATABASE_URL=${BLABSY_DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/blabsy_auth}
      - PUBLIC_REGISTRY_URL=${PUBLIC_REGISTRY_URL:-http://localhost:4321}
      - REGISTRY_SHARED_SECRET=${REGISTRY_SHARED_SECRET:-dev-secret-change-me}
      - GOOGLE_APPLICATION_CREDENTIALS=${GOOGLE_APPLICATION_CREDENTIALS:-}
      - FIREBASE_CREDENTIALS_PATH=${FIREBASE_CREDENTIALS_PATH:-}
      - BLABSY_MAPPING_DB_PATH=${BLABSY_MAPPING_DB_PATH:-/app/data/mapping-dbs/blabsy}
    volumes:
      - mapping_db_data:/app/data/mapping-dbs
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - metastate-socials-network
    <<: *common-host-access
    restart: unless-stopped

  # Blabsy Frontend
  blabsy:
    profiles:
      - socials
    build:
      context: .
      dockerfile: ./docker/Dockerfile.blabsy
    container_name: metastate-blabsy
    ports:
      - "8080:8080"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - NEXT_PUBLIC_BASE_URL=${PUBLIC_BLABSY_BASE_URL:-http://localhost:3000}
      - NEXT_PUBLIC_REGISTRY_URL=${PUBLIC_REGISTRY_URL:-http://localhost:4321}
    depends_on:
      blabsy-w3ds-auth-api:
        condition: service_started
    networks:
      - metastate-socials-network
    <<: *common-host-access
    restart: unless-stopped

  # Pictique API
  pictique-api:
    profiles:
      - socials
    build:
      context: .
      dockerfile: ./docker/Dockerfile.pictique-api
    container_name: metastate-pictique-api
    ports:
      - "1111:1111"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PORT=1111
      - DATABASE_URL=${PICTIQUE_DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/pictique}
      - PUBLIC_REGISTRY_URL=${PUBLIC_REGISTRY_URL:-http://localhost:4321}
      - REGISTRY_SHARED_SECRET=${REGISTRY_SHARED_SECRET:-dev-secret-change-me}
      - PICTIQUE_MAPPING_DB_PATH=${PICTIQUE_MAPPING_DB_PATH:-/app/data/mapping-dbs/pictique}
    volumes:
      - mapping_db_data:/app/data/mapping-dbs
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - metastate-socials-network
    <<: *common-host-access
    restart: unless-stopped

  # Pictique Frontend
  pictique:
    profiles:
      - socials
    build:
      context: .
      dockerfile: ./docker/Dockerfile.pictique
    container_name: metastate-pictique
    ports:
      - "5173:5173"
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - PUBLIC_PICTIQUE_BASE_URL=${PUBLIC_PICTIQUE_BASE_URL:-http://localhost:1111}
      - PUBLIC_REGISTRY_URL=${PUBLIC_REGISTRY_URL:-http://localhost:4321}
    depends_on:
      pictique-api:
        condition: service_started
    networks:
      - metastate-socials-network
    <<: *common-host-access
    restart: unless-stopped

volumes:
  postgres_socials_data:
    driver: local
  mapping_db_data:
    driver: local

networks:
  metastate-socials-network:
    driver: bridge
