version: "3.8"

x-common-host-access: &common-host-access
    extra_hosts:
        - "host.docker.internal:host-gateway"
    dns:
        - 8.8.8.8
        - 8.8.4.4
        - 1.1.1.1

services:
    # PostgreSQL database for registry and evault-core
    postgres:
        image: postgres:15-alpine
        container_name: metastate-postgres
        ports:
            - "5433:5432"
        environment:
            - POSTGRES_USER=postgres
            - POSTGRES_PASSWORD=postgres
            - POSTGRES_MULTIPLE_DATABASES=registry
        volumes:
            - postgres_data:/var/lib/postgresql/data
            - ./db/init-multiple-databases.sh:/docker-entrypoint-initdb.d/init-multiple-databases.sh
        networks:
            - metastate-core-network
        <<: *common-host-access
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres"]
            interval: 10s
            timeout: 5s
            retries: 5
        logging:
            driver: "none"

    # Neo4j for evault-core graph data
    neo4j:
        image: neo4j:5.15
        container_name: metastate-neo4j
        ports:
            - "7474:7474" # HTTP
            - "7687:7687" # Bolt
        environment:
            - NEO4J_AUTH=${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-neo4j}
            - NEO4J_USER=${NEO4J_USER:-neo4j}
            - NEO4J_PASSWORD=${NEO4J_PASSWORD:-neo4j}
            - NEO4J_dbms_connector_bolt_listen__address=0.0.0.0:7687
            - NEO4J_dbms_connector_http_listen__address=0.0.0.0:7474
            - NEO4J_dbms_connector_bolt_advertised__address=neo4j:7687
        volumes:
            - neo4j_data:/var/lib/neo4j/data
        networks:
            - metastate-core-network
        <<: *common-host-access
        entrypoint: ["/bin/sh", "-c"]
        command:
            - |
                # Remove any stale PID files before starting Neo4j
                rm -f /var/lib/neo4j/run/neo4j.pid 2>/dev/null || true
                rm -f /var/lib/neo4j/data/run/neo4j.pid 2>/dev/null || true
                rm -f /var/lib/neo4j/data/neo4j.pid 2>/dev/null || true
                find /var/lib/neo4j -name "*.pid" -type f -delete 2>/dev/null || true
                find /var/lib/neo4j/data -name "*.pid" -type f -delete 2>/dev/null || true
                exec /startup/docker-entrypoint.sh neo4j
        healthcheck:
            test:
                [
                    "CMD-SHELL",
                    "cypher-shell -u neo4j -p ${NEO4J_PASSWORD:-neo4j} 'RETURN 1' || exit 1",
                ]
            interval: 10s
            timeout: 5s
            retries: 10
            start_period: 30s

    # Registry service
    registry:
        profiles:
            - core
        build:
            context: .
            dockerfile: ./docker/Dockerfile.registry
            network: host
        container_name: metastate-registry
        ports:
            - "4321:4321"
        environment:
            - NODE_ENV=${NODE_ENV:-production}
            - DATABASE_URL=${REGISTRY_DATABASE_URL}
            - REGISTRY_SHARED_SECRET=${REGISTRY_SHARED_SECRET}
            - PUBLIC_REGISTRY_URL=${PUBLIC_REGISTRY_URL}
        depends_on:
            postgres:
                condition: service_healthy
        networks:
            - metastate-core-network
        <<: *common-host-access
        restart: unless-stopped

    # eVault Core service
    evault-core:
        profiles:
            - core
        build:
            context: .
            dockerfile: ./docker/Dockerfile.evault-core
            network: host
        container_name: metastate-evault-core
        ports:
            - "3001:3001" # Express (provisioning API)
            - "4000:4000" # Fastify (GraphQL/HTTP)
        environment:
            - NODE_ENV=${NODE_ENV:-production}
            - EXPRESS_PORT=3001
            - FASTIFY_PORT=4000
            - PORT=4000
            - REGISTRY_DATABASE_URL=${REGISTRY_DATABASE_URL}
            - PUBLIC_REGISTRY_URL=${PUBLIC_REGISTRY_URL}
            - REGISTRY_SHARED_SECRET=${REGISTRY_SHARED_SECRET}
            - NEO4J_URI=${NEO4J_URI:-bolt://neo4j:7687}
            - NEO4J_USER=${NEO4J_USER:-neo4j}
            - NEO4J_PASSWORD=${NEO4J_PASSWORD:-neo4j}
            - EVAULT_PUBLIC_KEY=${EVAULT_PUBLIC_KEY:-}
            - W3ID=${W3ID:-}
        depends_on:
            postgres:
                condition: service_healthy
            registry:
                condition: service_started
            neo4j:
                condition: service_healthy
        networks:
            - metastate-core-network
        <<: *common-host-access
        restart: unless-stopped

volumes:
    postgres_data:
        driver: local
    neo4j_data:
        driver: local

networks:
    metastate-core-network:
        driver: bridge
        driver_opts:
            com.docker.network.bridge.enable_icc: "true"
            com.docker.network.bridge.enable_ip_masquerade: "true"
        ipam:
            config:
                - subnet: 172.28.0.0/16
