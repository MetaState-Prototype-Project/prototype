<script lang="ts">
    import { goto } from "$app/navigation";
    import {
        PUBLIC_PROVISIONER_URL,
        PUBLIC_REGISTRY_URL,
    } from "$env/static/public";
    import { Hero } from "$lib/fragments";
    import { GlobalState } from "$lib/global";
    import { ButtonAction } from "$lib/ui";
    import Drawer from "$lib/ui/Drawer/Drawer.svelte";
    import { capitalize } from "$lib/utils";
    import { KeyManagerFactory, type KeyManager } from "$lib/crypto";
    import axios from "axios";
    import { getContext, onMount } from "svelte";
    import { Shadow } from "svelte-loading-spinners";
    import { v4 as uuidv4 } from "uuid";
    import DocumentType from "./steps/document-type.svelte";
    import Passport from "./steps/passport.svelte";
    import Selfie from "./steps/selfie.svelte";
    import {
        DocFront,
        DocBack,
        Selfie as SelfiePic,
        reason,
        status,
        verifStep,
        verificaitonId,
    } from "./store";

    type Document = {
        country: { value: string };
        firstIssue: Date;
        licenseNumber: string;
        number: {
            confidenceCategory: string;
            value: string;
            sources: string[];
        };
        placeOfIssue: string;
        processNumber: string;
        residencePermitType: string;
        type: { value: string };
        validFrom: {
            confidenceCategory: string;
            value: string;
            sources: string[];
        };
        validUntil: {
            confidenceCategory: string;
            value: string;
            sources: string[];
        };
    };

    type Person = {
        address: {
            confidenceCategory: string;
            value: string;
            components: Record<string, unknown>;
            sources: string[];
        };
        dateOfBirth: {
            confidenceCategory: string;
            value: string;
            sources: string[];
        };
        employer: string;
        extraNames: string;
        firstName: {
            confidenceCategory: string;
            value: string;
            sources: string[];
        };
        foreignerStatus: string;
        gender: {
            confidenceCategory: string;
            value: string;
            sources: string[];
        };
        idNumber: {
            confidenceCategory: string;
            value: string;
            sources: string[];
        };
        lastName: {
            confidenceCategory: string;
            value: string;
            sources: string[];
        };
        nationality: {
            confidenceCategory: string;
            value: string;
            sources: string[];
        };
        occupation: string;
        placeOfBirth: string;
    };

    let globalState: GlobalState | undefined = $state(undefined);
    let showVeriffModal = $state(false);
    let person: Person;
    let document: Document;
    let loading = $state(false);
    let keyManager: KeyManager | null = $state(null);
    let websocketData: { w3id?: string } | null = $state(null); // Store websocket data for duplicate case
    let hardwareKeySupported = $state(false);
    let hardwareKeyCheckComplete = $state(false);

    async function handleVerification() {
        const { data } = await axios.post(
            new URL("/verification", PUBLIC_PROVISIONER_URL).toString(),
        );
        verificaitonId.set(data.id);
        showVeriffModal = true;
        watchEventStream(data.id);
    }

    function watchEventStream(id: string) {
        const sseUrl = new URL(
            `/verification/sessions/${id}`,
            PUBLIC_PROVISIONER_URL,
        ).toString();
        const eventSource = new EventSource(sseUrl);

        eventSource.onopen = () => {
            console.log("Successfully connected.");
        };

        eventSource.onmessage = (e) => {
            const data = JSON.parse(e.data as string);
            if (!data.status) console.log(data);
            console.log("STATUS", data);
            status.set(data.status);
            reason.set(data.reason);
            person = data.person;
            document = data.document;
            websocketData = data; // Store the full websocket data
            if (data.status === "resubmission_requested") {
                DocFront.set(null);
                DocBack.set(null);
                SelfiePic.set(null);
            }
            verifStep.set(3);
        };
    }

    // Check if hardware key is supported on this device
    async function checkHardwareKeySupport() {
        try {
            const hardwareKeyManager =
                await KeyManagerFactory.getKeyManagerForContext(
                    "default",
                    "verification",
                );

            // Try to generate a test key to see if hardware is available
            await hardwareKeyManager.generate("test-hardware-check");
            hardwareKeySupported = true;
            console.log("Hardware key is supported on this device");
        } catch (error) {
            hardwareKeySupported = false;
            console.log("Hardware key is NOT supported on this device:", error);
        } finally {
            hardwareKeyCheckComplete = true;
        }
    }

    // Initialize key manager for verification context
    async function initializeKeyManager() {
        try {
            keyManager = await KeyManagerFactory.getKeyManagerForContext(
                "default",
                "verification",
            );
            console.log(`Key manager initialized: ${keyManager.getType()}`);
            return keyManager;
        } catch (error) {
            console.error("Failed to initialize key manager:", error);
            throw error;
        }
    }

    async function generateApplicationKeyPair() {
        if (!keyManager) {
            await initializeKeyManager();
        }

        if (!keyManager) {
            throw new Error("Key manager not initialized");
        }

        try {
            const res = await keyManager.generate("default");
            console.log("Key generation result:", res);
            return res;
        } catch (e) {
            console.error("Key generation failed:", e);
            throw e;
        }
    }

    async function getApplicationPublicKey() {
        if (!keyManager) {
            await initializeKeyManager();
        }

        if (!keyManager) {
            throw new Error("Key manager not initialized");
        }

        try {
            const res = await keyManager.getPublicKey("default");
            console.log("Public key retrieved:", res);
            return res;
        } catch (e) {
            console.error("Public key retrieval failed:", e);
            throw e;
        }
    }

    let handleContinue: () => Promise<void> = $state(async () => {});

    onMount(async () => {
        globalState = getContext<() => GlobalState>("globalState")();
        // handle verification logic + sec user data in the store

        // Check hardware key support first
        await checkHardwareKeySupport();

        // Initialize key manager and check if default key pair exists
        await initializeKeyManager();
        if (keyManager) {
            const keyExists = await keyManager.exists("default");
            if (!keyExists) {
                await generateApplicationKeyPair();
            }
        }

        handleContinue = async () => {
            if ($status !== "approved" && $status !== "duplicate")
                return verifStep.set(0);
            if (!globalState) throw new Error("Global state is not defined");

            loading = true;
            globalState.userController.user = {
                name: capitalize(
                    `${person.firstName.value} ${person.lastName.value}`,
                ),
                "Date of Birth": new Date(
                    person.dateOfBirth.value,
                ).toDateString(),
                "ID submitted": `Passport - ${person.nationality.value}`,
                "Passport Number": document.number.value,
            };
            globalState.userController.document = {
                "Valid From": new Date(document.validFrom.value).toDateString(),
                "Valid Until": new Date(
                    document.validUntil.value,
                ).toDateString(),
                "Verified On": new Date().toDateString(),
            };
            globalState.userController.isFake = false;

            if ($status === "duplicate") {
                // For duplicate case, skip provision and resolve the existing eVault URI
                // The w3id should be provided in the websocket data
                const existingW3id = websocketData?.w3id; // This should come from the websocket data
                if (!existingW3id) {
                    throw new Error("No w3id provided for duplicate eVault");
                }

                // Resolve the eVault URI from the registry
                const response = await axios.get(
                    new URL(
                        `resolve?w3id=${existingW3id}`,
                        PUBLIC_REGISTRY_URL,
                    ).toString(),
                );
                // Skip profile creation for duplicates by setting status directly
                globalState.vaultController.profileCreationStatus = "success";
                // For duplicates, just set the vault without triggering profile creation
                // since the eVault already exists with a profile
                globalState.vaultController.vault = {
                    uri: response.data.uri,
                    ename: existingW3id,
                };
            } else {
                // Normal flow for approved status
                const {
                    data: { token: registryEntropy },
                } = await axios.get(
                    new URL("/entropy", PUBLIC_REGISTRY_URL).toString(),
                );
                const { data } = await axios.post(
                    new URL("/provision", PUBLIC_PROVISIONER_URL).toString(),
                    {
                        registryEntropy,
                        namespace: uuidv4(),
                        verificationId: $verificaitonId,
                        publicKey: await getApplicationPublicKey(),
                    },
                );
                if (data.success === true) {
                    // Set vault in controller - this will trigger profile creation with retry logic
                    globalState.vaultController.vault = {
                        uri: data.uri,
                        ename: data.w3id,
                    };
                }
            }

            setTimeout(() => {
                goto("/register");
            }, 10_000);
        };
    });
</script>

<main
    class="pt-[3svh] px-[5vw] pb-[4.5svh] flex flex-col justify-between items-center"
>
    <section>
        <Hero title="Verify your account">
            {#snippet subtitle()}
                Get your passport ready. You’ll be directed to present your
                passport and take a quick selfie.
            {/snippet}
        </Hero>
        <img class="mx-auto mt-20" src="images/Passport.svg" alt="passport" />
    </section>
    {#if !hardwareKeyCheckComplete}
        <div class="w-full mt-10 flex justify-center">
            <div
                class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"
            ></div>
        </div>
    {:else if !hardwareKeySupported}
        <div
            class="w-full mt-10 p-4 bg-red-50 border border-red-200 rounded-lg"
        >
            <h3 class="text-red-800 font-semibold mb-2">
                Hardware Security Not Available
            </h3>
            <p class="text-red-700 text-sm">
                Your device doesn't support hardware-backed security keys
                required for identity verification. Please use a device with
                hardware security support or try the pre-verification option.
            </p>
        </div>
    {:else}
        <ButtonAction class="w-full mt-10" callback={handleVerification}
            >I'm ready</ButtonAction
        >
    {/if}
    <Drawer bind:isPaneOpen={showVeriffModal}>
        <div class="overflow-y-scroll">
            {#if $verifStep === 0}
                <DocumentType></DocumentType>
            {:else if $verifStep === 1}
                <Passport></Passport>
            {:else if $verifStep === 2}
                <Selfie></Selfie>
            {:else if loading}
                <div class="my-20">
                    <div
                        class="align-center flex w-full flex-col items-center justify-center gap-6"
                    >
                        <Shadow size={40} color="rgb(142, 82, 255);" />
                        <h3>Generating your eName</h3>
                    </div>
                </div>
            {:else}
                <div class="flex flex-col gap-6">
                    {#if $status === "approved"}
                        <div>
                            <h3>Your verification was a success</h3>
                            <p>You can now continue on to create your eName</p>
                        </div>
                    {:else if $status === "duplicate"}
                        <div>
                            <h3>Old eVault Found</h3>
                            <p>
                                We found an existing eVault associated with your
                                identity. You can claim it back to continue
                                using your account.
                            </p>
                        </div>
                    {:else if $status === "resubmission_requested"}
                        <h3>Your verification failed due to the reason</h3>
                        <p>{$reason}</p>
                    {:else}
                        <h3>Your verification failed</h3>

                        <p>{$reason}</p>
                    {/if}
                </div>
                <div class="flex w-full flex-col pt-4">
                    {#if $status !== "declined"}
                        <ButtonAction
                            class="w-[100%]"
                            callback={handleContinue}
                            color="primary"
                            >{$status === "approved"
                                ? "Continue"
                                : $status === "duplicate"
                                  ? "Claim old eVault"
                                  : "Retry"}</ButtonAction
                        >
                    {/if}
                </div>
            {/if}
        </div>
    </Drawer>
</main>
