<script lang="ts">
    import { goto } from "$app/navigation";
    import {
        PUBLIC_PROVISIONER_URL,
        PUBLIC_REGISTRY_URL,
    } from "$env/static/public";
    import { Hero } from "$lib/fragments";
    import { GlobalState } from "$lib/global";
    import { ButtonAction } from "$lib/ui";
    import Drawer from "$lib/ui/Drawer/Drawer.svelte";
    import { capitalize } from "$lib/utils";
    import {
        exists,
        generate,
        getPublicKey,
        // signPayload, verifySignature
    } from "@auvo/tauri-plugin-crypto-hw-api";
    import axios from "axios";
    import { getContext, onMount } from "svelte";
    import { Shadow } from "svelte-loading-spinners";
    import { v4 as uuidv4 } from "uuid";
    import Passport from "./steps/passport.svelte";
    import Selfie from "./steps/selfie.svelte";
    import {
        DocFront,
        Selfie as SelfiePic,
        reason,
        status,
        verifStep,
        verificaitonId,
    } from "./store";

    type Document = {
        country: { value: string };
        firstIssue: Date;
        licenseNumber: string;
        number: {
            confidenceCategory: string;
            value: string;
            sources: string[];
        };
        placeOfIssue: string;
        processNumber: string;
        residencePermitType: string;
        type: { value: string };
        validFrom: {
            confidenceCategory: string;
            value: string;
            sources: string[];
        };
        validUntil: {
            confidenceCategory: string;
            value: string;
            sources: string[];
        };
    };

    type Person = {
        address: {
            confidenceCategory: string;
            value: string;
            components: Record<string, unknown>;
            sources: string[];
        };
        dateOfBirth: {
            confidenceCategory: string;
            value: string;
            sources: string[];
        };
        employer: string;
        extraNames: string;
        firstName: {
            confidenceCategory: string;
            value: string;
            sources: string[];
        };
        foreignerStatus: string;
        gender: {
            confidenceCategory: string;
            value: string;
            sources: string[];
        };
        idNumber: {
            confidenceCategory: string;
            value: string;
            sources: string[];
        };
        lastName: {
            confidenceCategory: string;
            value: string;
            sources: string[];
        };
        nationality: {
            confidenceCategory: string;
            value: string;
            sources: string[];
        };
        occupation: string;
        placeOfBirth: string;
    };

    let globalState: GlobalState | undefined = $state(undefined);
    let showVeriffModal = $state(false);
    let person: Person;
    let document: Document;
    let loading = $state(false);

    async function handleVerification() {
        const { data } = await axios.post(
            new URL("/verification", PUBLIC_PROVISIONER_URL).toString(),
        );
        verificaitonId.set(data.id);
        showVeriffModal = true;
        watchEventStream(data.id);
    }

    function watchEventStream(id: string) {
        const sseUrl = new URL(
            `/verification/sessions/${id}`,
            PUBLIC_PROVISIONER_URL,
        ).toString();
        const eventSource = new EventSource(sseUrl);

        eventSource.onopen = () => {
            console.log("Successfully connected.");
        };

        eventSource.onmessage = (e) => {
            const data = JSON.parse(e.data as string);
            if (!data.status) console.log(data);
            console.log("STATUS", data);
            status.set(data.status);
            reason.set(data.reason);
            person = data.person;
            document = data.document;
            if (data.status === "resubmission_requested") {
                DocFront.set(null);
                SelfiePic.set(null);
            }
            verifStep.set(2);
        };
    }

    // IMO, call this function early, check if hardware even supports the app
    // docs: https://github.com/auvoid/tauri-plugin-crypto-hw/blob/48d0b9db7083f9819766e7b3bfd19e39de9a77f3/examples/tauri-app/src/App.svelte#L13
    async function generateApplicationKeyPair() {
        let res: string | undefined;
        try {
            res = await generate("default");
            console.log(res);
        } catch (e) {
            // Put hardware crypto missing error here
            console.log(e);
        }
        return res;
    }

    async function getApplicationPublicKey() {
        let res: string | undefined;
        try {
            res = await getPublicKey("default");
            console.log(res);
        } catch (e) {
            console.log(e);
        }
        return res; // check getPublicKey doc comments (multibase hex format)
    }

    let handleContinue: () => Promise<void>;

    onMount(() => {
        globalState = getContext<() => GlobalState>("globalState")();
        // handle verification logic + sec user data in the store

        // check if default key pair exists
        const keyExists = exists("default");
        if (!keyExists) {
            generateApplicationKeyPair();
        }

        handleContinue = async () => {
            if ($status !== "approved") return verifStep.set(0);
            if (!globalState) throw new Error("Global state is not defined");

            loading = true;
            globalState.userController.user = {
                name: capitalize(
                    `${person.firstName.value} ${person.lastName.value}`,
                ),
                "Date of Birth": new Date(
                    person.dateOfBirth.value,
                ).toDateString(),
                "ID submitted": `Passport - ${person.nationality.value}`,
                "Passport Number": document.number.value,
            };
            globalState.userController.document = {
                "Valid From": new Date(document.validFrom.value).toDateString(),
                "Valid Until": new Date(
                    document.validUntil.value,
                ).toDateString(),
                "Verified On": new Date().toDateString(),
            };
            globalState.userController.isFake = false;
            const {
                data: { token: registryEntropy },
            } = await axios.get(
                new URL("/entropy", PUBLIC_REGISTRY_URL).toString(),
            );
            const { data } = await axios.post(
                new URL("/provision", PUBLIC_PROVISIONER_URL).toString(),
                {
                    registryEntropy,
                    namespace: uuidv4(),
                    verificationId: $verificaitonId,
                    publicKey: await getApplicationPublicKey(),
                },
            );
            if (data.success === true) {
                globalState.vaultController.vault = {
                    uri: data.uri,
                    ename: data.w3id,
                };
            }
            setTimeout(() => {
                goto("/register");
            }, 10_000);
        };
    });
</script>

<main
    class="pt-[3svh] px-[5vw] pb-[4.5svh] flex flex-col justify-between items-center"
>
    <section>
        <Hero title="Verify your account">
            {#snippet subtitle()}
                Get your passport ready. Youâ€™ll be directed to present your
                passport and take a quick selfie.
            {/snippet}
        </Hero>
        <img class="mx-auto mt-20" src="images/Passport.svg" alt="passport" />
    </section>
    <ButtonAction class="w-full mt-10" callback={handleVerification}
        >I'm ready</ButtonAction
    >
    <Drawer bind:isPaneOpen={showVeriffModal}>
        <div class="overflow-y-scroll">
            {#if $verifStep === 0}
                <Passport></Passport>
            {:else if $verifStep === 1}
                <Selfie></Selfie>
            {:else if loading}
                <div class="my-20">
                    <div
                        class="align-center flex w-full flex-col items-center justify-center gap-6"
                    >
                        <Shadow size={40} color="rgb(142, 82, 255);" />
                        <h3>Generating your eName</h3>
                    </div>
                </div>
            {:else}
                <div class="flex flex-col gap-6">
                    {#if $status === "approved"}
                        <div>
                            <h3>Your verification was a success</h3>
                            <p>You can now continue on to create your eName</p>
                        </div>
                    {:else if $status === "resubmission_requested"}
                        <h3>Your verification failed due to the reason</h3>
                        <p>{$reason}</p>
                    {:else}
                        <h3>Your verification failed</h3>

                        <p>{$reason}</p>
                    {/if}
                </div>
                <div class="flex w-full flex-col pt-4">
                    {#if $status !== "declined"}
                        <ButtonAction
                            class="w-[100%]"
                            callback={handleContinue}
                            color="primary"
                            >{$status === "approved"
                                ? "Continue"
                                : "Retry"}</ButtonAction
                        >
                    {/if}
                </div>
            {/if}
        </div>
    </Drawer>
</main>
